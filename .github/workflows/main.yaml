name: Build and Sync

on: [push]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build tools
      run: python -m pip install --upgrade setuptools wheel build

    - name: Build wheel
      run: python -m build

    - name: Configure SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Add remote server to known hosts
      run: ssh-keyscan -p 19099 ehr.stalent.cn >> ~/.ssh/known_hosts

    - name: Sync to remote server
      run: |
        rsync -avz --progress --delete -e "ssh -p 19099" \
          dist/ \
          chenxueliang@ehr.stalent.cn:/home/chenxueliang/lby/emma/dist/
    
    - name: Trigger remote server refresh
      run: "curl -H \"Authorization: Bearer d642d78ec3a4da9b96ef624b43bb0e82\" http://ehr.stalent.cn:19096?dist=emma"